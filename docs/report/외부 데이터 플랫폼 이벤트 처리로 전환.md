## ì™¸ë¶€ ë°ì´í„° í”Œë«í¼ ì´ë²¤íŠ¸ ì²˜ë¦¬ë¡œ ì „í™˜

### 1. ëª©ì 
- ì£¼ë¬¸ ë° ê²°ì œ ì²˜ë¦¬ ì‹œ (`orderFacade.orderPayment`) `orderService.paidOrder` ì—ì„œ ì™¸ë¶€ ë°ì´í„° í”Œë«í¼ì— ì£¼ë¬¸ ì •ë³´ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.
- ë§Œì•½ ì™¸ë¶€ ë°ì´í„° í”Œë«í¼ ì „ì†¡(`orderExternalClient.sendOrderMessage`) ì‹œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ê²Œ ë˜ë©´ ì£¼ë¬¸ ë° ê²°ì œ Txì— ì˜í–¥ì„ ë¼ì¹˜ê²Œ ë©ë‹ˆë‹¤.
- ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì£¼ë¬¸ ë° ê²°ì œ ì²˜ë¦¬ í›„ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ì—¬ ì™¸ë¶€ ë°ì´í„° í”Œë«í¼ì— ì£¼ë¬¸ ì •ë³´ë¥¼ ì „ì†¡í•˜ê³ ì í•©ë‹ˆë‹¤.

---

### 2. AS-IS
- `orderService.paidOrder` ì—ì„œ ì™¸ë¶€ ë°ì´í„° í”Œë«í¼ìœ¼ë¡œ ì „ì†¡í•˜ëŠ” ë©”ì†Œë“œë¥¼ ë‹¨ìˆœ í˜¸ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤.
```java
    // OrderService.java
    @Transactional
    public void paidOrder(Long orderId) {
        Order order = orderRepository.findById(orderId);
        order.paid(LocalDateTime.now());

        orderExternalClient.sendOrderMessage(order);
    }

    // OrderExternalClient.java
    public interface OrderExternalClient {

        void sendOrderMessage(Order order);

    }

    // OrderExternalClientImpl.java
    @Slf4j
    @Component
    public class OrderExternalClientImpl implements OrderExternalClient {

        @Override
        public void sendOrderMessage(Order order) {
            log.info("ì™¸ë¶€ ë°ì´í„° í”Œë«í¼ ì£¼ë¬¸ì •ë³´ ì €ì¥ : {}", order);
        }
    }
```

---

### 3. TO-BE
- ì™¸ë¶€ ë°ì´í„° í”Œë«í¼ì— ì£¼ë¬¸ ì •ë³´ë¥¼ ì „ì†¡í•˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.
- ì£¼ë¬¸ ë° ê²°ì œ ì²˜ë¦¬ ì‹œ í•´ë‹¹ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ í˜¸ì¶œí•˜ì—¬ ì™¸ë¶€ ë°ì´í„° í”Œë«í¼ì— ì£¼ë¬¸ ì •ë³´ë¥¼ ì „ì†¡í•˜ë„ë¡ í•©ë‹ˆë‹¤.  

> ğŸ“Œ ì´ë²¤íŠ¸ í˜¸ì¶œìš© ê°ì²´
```java
@Getter
public class OrderInfoEvent {

    private final Long orderId;
    private final Long userId;
    private final Long userCouponId;
    private final long totalPrice;
    private final long discountPrice;
    private final LocalDateTime paidAt;
    private final List<OrderInfoItemEvent> orderItems;

    public OrderInfoEvent(Order order) {
        this.orderId = order.getId();
        this.userId = order.getUserId();
        this.userCouponId = order.getUserCouponId();
        this.totalPrice = order.getTotalPrice();
        this.discountPrice = order.getDiscountPrice();
        this.paidAt = order.getPaidAt();

        List<OrderInfoItemEvent> result = new ArrayList<>();
        for (OrderItem orderItem : order.getOrderItems()) {
            result.add(new OrderInfoItemEvent(orderItem));
        }

        this.orderItems = result;
    }

    public class OrderInfoItemEvent {

        private final Long productId;
        private final String productName;
        private final Long unitPrice;
        private final int quantity;

        public OrderInfoItemEvent(OrderItem item) {
            this.productId = item.getProductId();
            this.productName = item.getProductName();
            this.unitPrice = item.getUnitPrice();
            this.quantity = item.getQuantity();
        }

    }

} 
```

> ğŸ“Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
```java
@Component
@RequiredArgsConstructor
@Slf4j
public class OrderInfoEventListener {

    private final OrderExternalClient orderExternalClient;

    @Async("orderEventExecutor")
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void orderSuccessHandler(Order order) {

        log.info("ì£¼ë¬¸ ì •ë³´ ì´ë²¤íŠ¸ ë°œí–‰");

        orderExternalClient.sendOrderMessage(order);
    }

}
```

> ğŸ“Œ ì´ë²¤íŠ¸ í¼ë¸”ë¦¬ì…”
```java
@Component
@RequiredArgsConstructor
public class OrderInfoEventPublisher {

    private final ApplicationEventPublisher applicationEventPublisher;

    public void success(Order order) {
        applicationEventPublisher.publishEvent(order);
    }

}
```

> ğŸ“Œ `orderFacade.orderPayment` -> `orderService.paidOrder` ì—ì„œ ì™¸ë¶€ ë°ì´í„° í”Œë«í¼ì— ì „ì†¡í•˜ëŠ” ë¶€ë¶„ ìˆ˜ì •
```java
    @Transactional
    public void paidOrder(Long orderId) {
        Order order = orderRepository.findById(orderId);
        order.paid(LocalDateTime.now());
        
        orderInfoEventPublisher.success(order);
    }
```

---

> **ğŸ“œì°¸ê³  1. Async ì„¤ì •**  
> 1. `@EnableAsyncê°€ í•„ìš”í•œ ì´ìœ `
>    1. ë¹ˆ í›„ì²˜ë¦¬ê¸° ë“±ë¡: `@EnableAsync`ë¥¼ ì„ ì–¸í•˜ë©´, Springì´ `AsyncAnnotaionBeanPostProcessor` ë¼ëŠ” ë¹ˆ í›„ì²˜ë¦¬ê¸°ë¥¼ ì»¨í…ìŠ¤íŠ¸ì— ë“±ë¡í•©ë‹ˆë‹¤.
>    2. í”„ë¡ì‹œ ìƒì„±: ì´ í›„ì²˜ë¦¬ê¸°ê°€ `@Async`ê°€ ë¶™ì€ ë©”ì„œë“œë¥¼ ê°€ì§„ ë¹ˆì„ ì°¾ì•„ AOP í”„ë¡ì‹œë¥¼ ì”Œì›Œ ì¤ë‹ˆë‹¤.
>    3. AOP ê¸°ë°˜ ë¹„ë™ê¸° í˜¸ì¶œ: í”„ë¡ì‹œë¥¼ í†µí•´ ë©”ì„œë“œ í˜¸ì¶œì´ ë“¤ì–´ì˜¤ë©´, ì‹¤ì œ ë©”ì„œë“œ ë¡œì§ì€ ë³„ë„ì˜ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰í•˜ë„ë¡ `TaskExecutor`ì— ìœ„ì„í•˜ê²Œ ë©ë‹ˆë‹¤.
>    4. íš¨ê³¼: `@EnableAsync`ê°€ ì—†ìœ¼ë©´, @AsyncëŠ” ë‹¨ìˆœíˆ ìŠ¤í”„ë§ì´ ëª¨ë¥´ëŠ” ì• í† ë„¤ì´ì…˜ì´ ë˜ê³ , ë©”ì„œë“œê°€ ë™ê¸°ì ìœ¼ë¡œ ë°”ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.
> 2. ì»¤ìŠ¤í…€ `Executor` ë¹ˆì„ ë“±ë¡í•´ì•¼ í•˜ëŠ” ì´ìœ   
>    ìŠ¤í”„ë§ì€ `@Async`ë¥¼ ìœ„í•´ ë‚´ë¶€ì ìœ¼ë¡œ `TaskExecutor`ë¥¼ ì‚¬ìš©í•˜ëŠ”ë°, 
>    ê¸°ë³¸ ì„¤ì •ì—ëŠ” íŠ¹ë³„í•œ ìŠ¤ë ˆë“œí’€ ì—†ì´ ë§¤ë²ˆ ìƒˆ ìŠ¤ë ˆë“œë¥¼ ìƒì„±í•˜ëŠ” `SimpleAsyncTaskExecutor`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.  
>    ì´ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
>    1. ë¬´ì œí•œ ìŠ¤ë ˆë“œ ìƒì„±:   
>    ë™ì‹œ í˜¸ì¶œì´ ë§ì•„ì§€ë©´ ìŠ¤ë ˆë“œê°€ ê³„ì† ëŠ˜ì–´ë‚˜ì„œ ê²°êµ­ ê³¼ë„í•œ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ê³¼ ë©”ëª¨ë¦¬ ì‚¬ìš©ìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„±ëŠ¥ì´ ê¸‰ë½í•©ë‹ˆë‹¤.
>    2. ìŠ¤ë ˆë“œ ì´ë¦„, í’€ í¬ê¸° ê´€ë¦¬ ë¶ˆê°€:  
>    ë””ë²„ê¹…ì´ë‚˜ ëª¨ë‹ˆí„°ë§ ì‹œ, ì–´ë–¤ ì‘ì—…ì´ ì–´ëŠ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ êµ¬ë¶„í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤.
>    3. Queue-Backoff ì „ëµ ë¶€ì¬:  
>    ìŠ¤ë ˆë“œê°€ ëª¨ë‘ ë°”ì˜ë©´ ëŒ€ê¸°ì—´ì— ìŒ“ê³  ì ì ˆíˆ ê±°ì ˆí•˜ê±°ë‚˜ ì§€ì—°(backoff)í•  ìˆ˜ ìˆì–´ì•¼ í•˜ëŠ”ë°, `SimpleAsyncTaskExecutor`ëŠ” ì´ëŸ° ì œì–´ ê¸°ëŠ¥ì´ ì—†ìŠµë‹ˆë‹¤.
```java
@Configuration
@EnableAsync
public class AsyncConfig {

    @Bean(name = "orderEventExecutor")
    public Executor orderEventExecutor() {
        ThreadPoolTaskExecutor exec = new ThreadPoolTaskExecutor();
        exec.setCorePoolSize(2);
        exec.setMaxPoolSize(5);
        exec.setQueueCapacity(50);
        exec.setThreadNamePrefix("OrderEvent.");
        exec.initialize();
        return exec;
    }
}
```
- CorePoolSize / MaxPoolSize:  
  ìµœì†Œ/ìµœëŒ€ ìŠ¤ë ˆë“œ ê°¯ìˆ˜ë¥¼ ì„¤ì •í•´ì„œ ìì› ê³¼ë‹¤ ì‚¬ìš©ì„ ë°©ì§€
- QueueCapacity:  
  ìµœëŒ€ í ê¸¸ì´ë¥¼ ì •í•´ ê³¼ë„í•œ ì‘ì—… í­ì¦ ì‹œ ê±°ì ˆ ì •ì±…ì„ ì„ íƒ ê°€ëŠ¥
- ThreadNamePrefix:  
  ë¡œê·¸, ìŠ¤ë ˆë“œ ë¤í”„ ë¶„ì„ ì‹œ ì–´ë–¤ ì‘ì—…ì´ ì–´ëŠ í’€ì˜ ìŠ¤ë ˆë“œì¸ì§€ ëª…í™•í•˜ê²Œ í‘œê¸°

---

> **ğŸ“œì°¸ê³  2. ì˜ˆì™¸ ì²˜ë¦¬ ë° ì¬ì‹œë„ ì „ëµ**  
> ì™¸ë¶€ í”Œë«í¼ í˜¸ì¶œì´ ì‹¤íŒ¨í–ˆì„ ë•Œ,
> - `@Async`ë¡œ ë¹„ë™ê¸° ì‹¤í–‰ë˜ë”ë¼ë„ ê¸°ë³¸ì ìœ¼ë¡œ ì¬ì‹œë„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
> - ì¤‘ìš”í•œ ë°ì´í„°ë¼ë©´ `Spring Retry ë‚˜ í(ì˜ˆ: Kafka, RabbitMQ) ê¸°ë°˜ ì¬ì‹œë„ ë¡œì§ì„ ì¶”ê°€í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.
> - ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ ë³„ë„ Dead-Letter íë¡œ ë³´ë‚´ê³  ìš´ì˜ìê°€ ì¬ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ í•  ìˆ˜ë„ ìˆë‹¤ê³  í•©ë‹ˆë‹¤.
```java
@Async("orderEventExecutor")
@TransactionalEventListener(phase = AFTER_COMMIT)
@Retryable(
  value = { ExternalPlatformException.class },
  maxAttempts = 3,
  backoff = @Backoff(delay = 5000)
)
public void orderSuccessHandler(OrderInfoEvent evt) {
    orderExternalClient.sendOrderMessage(evt);
}
```